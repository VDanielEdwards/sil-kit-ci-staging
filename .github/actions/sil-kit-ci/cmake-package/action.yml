name: sil-kil-ci/cmake-build

description: Package the project with CMake (CTest).

inputs:

  preset-name:
    description: The preset name from CMakePresets.json.
    required: true

  linux-docker-image:
    default: ghcr.io/mariusbgm/sil-kit-ci-ubuntu-22.04:main
    description: Docker image used under Linux
    required: false

  cmake-source-directory:
    description: The source directory for use by the cmake actions
    required: true

  cmake-build-directory:
    description: The build directory for use by the cmake actions
    required: true

  cmake-package-directory:
    description: The package directory for use by the cmake actions
    required: true

  upload-artifacts:
    description: Determines if artifacts created by the actions should be uploaded
    required: true

  retention-days:
    description: Determines the number of days any uploaded artifacts should be retained
    required: true

  package-name:
    description: Name of the package to upload as an artifact
    required: true

runs:
  using: composite
  steps:

    - name: (linux) package cmake project
      id: cmake-package
      if: runner.os == 'Linux'
      shell: bash
      run: |
        docker run \
          -v "${{ inputs.cmake-source-directory }}:/s" \
          -v "${{ inputs.cmake-build-directory }}:/b" \
          -v "${{ inputs.cmake-package-directory }}:/p" \
          "${{ inputs.linux-docker-image }}" \
            cmake \
              --build /b \
              --target package

        echo "package-path=${{ inputs.cmake-package-directory }}/*/ZIP/SilKit-*-*.zip" >> "$GITHUB_OUTPUT"

    - name: (windows) package cmake project
      id: cmake-package
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        echo "FFFFFFFF!!"

    - name: upload package
      if: ${{ inputs.upload-artifacts == 'true' }}
      uses: actions/upload-artifact@v3
      with:
        name: ${{ inputs.package-name }}
        path: ${{ steps.cmake-package.outputs.package-path }}
        if-no-files-found: 'error'
        retention-days: ${{ inputs.retention-days }}